//weight is mapped to size in d3js


var geneticData = {
 "name": "Performance",
 "type": "root", 
 "children": [
  {
   "name": "Endurance",
   "type": "category",
   "linkcolor": "#00a65a",
   "className" : "endurance",
   "children": [
    {
     "name": "Heart Capacity",
     "type": "phenotype",
     "linkcolor": "#00a65a",
     "className" : "endurance",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 9
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 9
      }
     ]
    },
    {
     "name": "Endurance",
     "type": "phenotype",
     "linkcolor": "#00a65a",
     "className" : "endurance",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 1,
        "size": 9
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00a65a",
        "className" : "endurance", 
        "value": 2,
        "size": 9
      }
     ]
    }
   ]
  },
  {
   "name": "Power",
   "type": "category",
   "linkcolor": "#00c0ef",
   "className" : "power",
   "children": [
    {
     "name": "Strength",
     "type": "phenotype",
     "linkcolor": "#00c0ef",
     "className" : "power",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 2,
        "size": 9
      }
      
     ]
    },
    {
     "name": "Power Capacity",
     "type": "phenotype",
     "linkcolor": "#00c0ef",
     "className" : "power",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#00c0ef",
        "className" : "power", 
        "value": 1,
        "size": 9
      }
     ]
    }
   ]
  },
  {
   "name": "Metabolism",
   "type": "category",
   "linkcolor": "#0073b7",
   "className" : "metabolism",
   "children": [
    {
     "name": "Energy",
     "type": "phenotype",
     "linkcolor": "#0073b7",
     "className" : "metabolism",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 2,
        "size": 9
      }
      
     ]
    },
    {
     "name": "Propensity to Exercise",
     "type": "phenotype",
     "linkcolor": "#0073b7",
     "className" : "metabolism",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#0073b7",
        "className" : "metabolism", 
        "value": 1,
        "size": 9
      }
     ]
    }
   ]
  },
  {
   "name": "Recovery",
   "type": "category",
   "linkcolor": "#f56954",
   "className" : "recovery",
   "children": [
    {
     "name": "Recovery",
     "type": "phenotype",
     "linkcolor": "#f56954",
     "className" : "recovery",
     "children": [
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 112341",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 0,
        "size": 8
      },
      {
        "name": "Gene 24234", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 1,
        "size": 4
      },
      {
        "name": "Gene 35243", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 9
      }
      
     ]
    },
    {
     "name": "Muscle Fatigue",
     "type": "phenotype",
     "linkcolor": "#f56954",
     "className" : "recovery",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 1,
        "size": 9
      }
     ]
    },
    {
     "name": "Lung Capacity",
     "type": "phenotype",
     "linkcolor": "#f56954",
     "className" : "recovery",
     "children": [
      {
        "name": "Gene 673654",
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 2
      },
      {
        "name": "Gene 263462", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 2,
        "size": 4
      },
      {
        "name": "Gene 37777", 
        "type": "Gene ",
        "linkcolor": "#f56954",
        "className" : "recovery", 
        "value": 1,
        "size": 9
      }
     ]
    }
   ]
  }
 ]
};

var geneticData2 = {
  "name": "performance",
  "children": [
    {
      "name": "1",
      "children": [
        {
          "name": "endurance",
          "children": [
            {
              "": "1",
              "id": "1",
              "category": "1",
              "sub_category": "endurance",
              "gene_name": "ACTN3",
              "gene_function": "ACTN3 (actinin alpha 3) is an actin-binding protein expressed in skeletal muscle that is involved in the ability of muscles to produce fast contractions.",
              "name": "rs1815739",
              "pmid": "17550918",
              "x_cases": "112",
              "x_controls": "123",
              "p_value": "0.041",
              "odds_ratio": "n/a",
              "journal_rank": "4084",
              "rank": "2",
              "far_allele": "T",
              "hypothetical_genotype": "TT",
              "varient_score": "3",
              "weight": "2",
              "remark_1": "NA",
              "remark_2": "NA",
              "remark_3": "NA"
            },
            {
              "": "2",
              "id": "2",
              "category": "1",
              "sub_category": "endurance",
              "gene_name": "ACE",
              "gene_function": "ACE (angiotensin-converting enzyme) is a vasoconstrictor enzyme that is related to electrolyte balance and systemic blood pressure by causing blood vessels to constrict and blood pressure to increase. In athletic performance, it is related to cardiovascular and skeletal muscle function, fast twitch muscle activity, and muscle efficiency.",
              "name": "rs1799752",
              "pmid": "19237423",
              "x_cases": "46",
              "x_controls": "123",
              "p_value": "0.006",
              "odds_ratio": "1.5",
              "journal_rank": "n/a",
              "rank": "1",
              "far_allele": "I",
              "hypothetical_genotype": "II",
              "varient_score": "2",
              "weight": "1",
              "remark_1": "NA",
              "remark_2": "NA",
              "remark_3": "NA"
            },
            {
              "": "3",
              "id": "3",
              "category": "1",
              "sub_category": "endurance",
              "gene_name": "ADRB2",
              "gene_function": "ADRB2/ADRB3 (adrenergic beta-2/beta-3 receptor) encode proteins in the family of beta adrenergic receptors which trigger agonist-stimulated adenylyl cyclase activity to divert blood flow to skeletal muscle. The beta-2-adrenergic receptor is responsible for increases in bronchodilation, ventricular function, and vasodilation, which impact the cardiovascular and pulmonary response to exercise. The beta-3-adrenergic receptor is involved in the regulation of lipolysis and thermogenesis.",
              "name": "rs1042713",
              "pmid": "20044476",
              "x_cases": "438",
              "x_controls": "0",
              "p_value": "0.01",
              "odds_ratio": "n/a",
              "journal_rank": "749",
              "rank": "1",
              "far_allele": "A",
              "hypothetical_genotype": "AG",
              "varient_score": "1",
              "weight": "1",
              "remark_1": "NA",
              "remark_2": "NA",
              "remark_3": "NA"
            },
            {
              "": "7",
              "id": "7",
              "category": "1",
              "sub_category": "endurance",
              "gene_name": "GNB3 ",
              "gene_function": "GNB3 (guanine nucleotide-binding protein subunit beta-3) is involved in transmembrane signaling systems and G protein activation of hormones, neurotransmitters, chemokines, and local mediators that may be conducive to athletic performance.",
              "name": "rs5443",
              "pmid": "19139061",
              "x_cases": "155",
              "x_controls": "234",
              "p_value": "0.046",
              "odds_ratio": "4.49",
              "journal_rank": "2490",
              "rank": "1",
              "far_allele": "C",
              "hypothetical_genotype": "CC",
              "varient_score": "NA",
              "weight": "1",
              "remark_1": "NA",
              "remark_2": "NA",
              "remark_3": "NA"
            }
          ]
        },
        {
          "name": "power",
          "children": [
            {
              "": "8",
              "id": "8",
              "category": "1",
              "sub_category": "power",
              "gene_name": "ACTN3 ",
              "gene_function": "ACTN3 (actinin alpha 3) is an actin-binding protein expressed in skeletal muscle that is involved in the ability of muscles to produce fast contractions.",
              "name": "rs1815739",
              "pmid": "17550918",
              "x_cases": "112",
              "x_controls": "123",
              "p_value": "0.041",
              "odds_ratio": "n/a",
              "journal_rank": "4084",
              "rank": "2",
              "far_allele": "T",
              "hypothetical_genotype": "CC",
              "varient_score": "NA",
              "weight": "2",
              "remark_1": "NA",
              "remark_2": "NA",
              "remark_3": "NA"
            },
            {
              "": "9",
              "id": "9",
              "category": "1",
              "sub_category": "power",
              "gene_name": "ACE ",
              "gene_function": "ACE (angiotensin-converting enzyme) is a vasoconstrictor enzyme that is related to electrolyte balance and systemic blood pressure by causing blood vessels to constrict and blood pressure to increase. In athletic performance, it is related to cardiovascular and skeletal muscle function, fast twitch muscle activity, and muscle efficiency.",
              "name": "rs1799752",
              "pmid": "19237423",
              "x_cases": "46",
              "x_controls": "123",
              "p_value": "0.006",
              "odds_ratio": "1.5",
              "journal_rank": "n/a",
              "rank": "1",
              "far_allele": "D",
              "hypothetical_genotype": "II",
              "varient_score": "NA",
              "weight": "1",
              "remark_1": "NA",
              "remark_2": "NA",
              "remark_3": "NA"
            },
            {
              "": "10",
              "id": "10",
              "category": "1",
              "sub_category": "power",
              "gene_name": "AGT ",
              "gene_function": "AGT (angiotensinogen) is an essential component of the renin-angiotensin system (RAS), a regulator of blood pressure, body fluid, and electrolyte homeostasis, and in athletic performance, blood pressure response to exercise.",
              "name": "rs699",
              "pmid": "20029521",
              "x_cases": "163",
              "x_controls": "119",
              "p_value": "0.008",
              "odds_ratio": "1.681",
              "journal_rank": "n/a",
              "rank": "1",
              "far_allele": "C",
              "hypothetical_genotype": "AG",
              "varient_score": "NA",
              "weight": "1",
              "remark_1": "NA",
              "remark_2": "NA",
              "remark_3": "NA"
            }
          ]
        }
      ]
    }
  ]
}; 

var w = 300 - 80,
    h = 280 - 180,
    x = d3.scale.linear().range([0, w]),
    y = d3.scale.linear().range([0, h]),
    root,
    node;

// Has the color mapping for different categories Using color brewer





var color = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.YlOrRd[3]);
var enduranceColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.Greens[3]);
var powerColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.Purples[3]);
var metabolismColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.YlOrRd[3]);
var recoveryColor = d3.scale.ordinal()
  .domain([1,2,3])
  .range(colorbrewer.Blues[3]);

// d3.csv("data/sm_chip.csv", function(error, csv_data) {
//     var treeData = {"key": "performance", 
//                     "values": d3.nest()
//                                 .key(function (d) { return d.category; })
//                                 .key(function (d) { return d.sub_category; })
//                                 .key(function (d) { return d.rs_id; })
//                                 .entries(csv_data)
//   };

// });

// console.log(treeData);


var treemap = d3.layout.treemap()
    // .children(function(d) { return d.values;})
    .round(true)
    .size([w, h])
    .sticky(true)
    .value(function (d) {
    return d.size;
});

var svg = d3.select(".viz").append("div")
    .attr("class", "chart")
    .style("width", w + "px")
    .style("height", h + "px")
    .append("svg:svg")
    .attr("width", w)
    .attr("height", h)
    .append("svg:g")
    .attr("transform", "translate(.5,.5)");





node = root = geneticData;
console.log(root);

var nodes = treemap.nodes(root)
    .filter(function (d) {
    return !d.children;
});

var cell = svg.selectAll("g")
    .data(nodes)
    .enter().append("svg:g")
    .attr("class", "cell")
    .attr("transform", function (d) {
    return "translate(" + d.x + "," + d.y + ")";
})
    .on("click", function (d) {
    return zoom(node == d.parent ? root : d.parent);
});

cell.append("svg:rect")
    .attr("width", function (d) {
    return d.dx - 1;
})
    .attr("height", function (d) {
    return d.dy - 1;
})
    .style("fill", function (d) {
      if (d.className == "endurance") {
        return enduranceColor(d.value);
      }
      if (d.className == "power") {
        return powerColor(d.value);
      }
      if (d.className == "metabolism") {
        return metabolismColor(d.value);
      }
      if (d.className == "recovery") {
        return recoveryColor(d.value);
      }
    return color(d.value);
});

cell.append("svg:text")
    .attr("x", function (d) {
    return d.dx / 2;
})
    .attr("y", function (d) {
    return d.dy / 2;
})
    .attr("dy", ".35em")
    .attr("text-anchor", "middle")
    .text(function (d) {
    return d.name;
})
    .style("opacity", function (d) {
    d.w = this.getComputedTextLength();
    return d.dx > d.w ? 1 : 0;
});

d3.select(window).on("click", function () {
    zoom(root);
});

d3.select("select").on("change", function () {
    treemap.value(this.value == "size" ? size : count).nodes(root);
    zoom(node);
});

function size(d) {
    return d.size;
}

function count(d) {
    return 1;
}

function zoom(d) {
    var kx = w / d.dx,
        ky = h / d.dy;
    x.domain([d.x, d.x + d.dx]);
    y.domain([d.y, d.y + d.dy]);

    var t = svg.selectAll("g.cell").transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .attr("transform", function (d) {
        return "translate(" + x(d.x) + "," + y(d.y) + ")";
    });

    t.select("rect")
        .attr("width", function (d) {
        return kx * d.dx - 1;
    })
        .attr("height", function (d) {
        return ky * d.dy - 1;
    })

    t.select("text")
        .attr("x", function (d) {
        return kx * d.dx / 2;
    })
        .attr("y", function (d) {
        return ky * d.dy / 2;
    })
        .style("opacity", function (d) {
        return kx * d.dx > d.w ? 1 : 0;
    });

    node = d;
    d3.event.stopPropagation();
}